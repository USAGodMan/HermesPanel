services:
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: hermes-backend
    restart: unless-stopped
    environment:
      - DB_TYPE=${DB_TYPE:-sqlite}
      - DATABASE_DSN=${DATABASE_DSN:-/app/data/db.sqlite}
      - GRPC_PORT=50051
      - HTTP_PORT=8080
      - AES_ENCRYPTION_KEY=${AES_ENCRYPTION_KEY}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - GIN_MODE=release
      - TZ=Asia/Shanghai
    volumes:
      - sqlite_data:/app/data
      - backend_logs:/app/logs
    networks:
      - hermes-net
    # healthcheck:
    #   test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/v1/health || exit 1"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 5
    #   start_period: 60s

  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    container_name: hermes-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-80}:80"   # 只暴露 80
    depends_on:
      - backend                  # 【改成普通依赖】不等 healthy，直接等启动即可
    networks:
      - hermes-net

volumes:
  sqlite_data:
    name: sqlite_data
    driver: local
  backend_logs:
    name: backend_logs
    driver: local

networks:
  hermes-net:
    name: hermes-net
    driver: bridge
